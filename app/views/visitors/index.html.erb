<div class="container-fluid">
  <h3>Adam Bielecki & Denis Urubko GPS signal (No API limits)</h3>

  <div>
    <div id="sidebar_builder" class="map_container"></div>
  </div>
  <div id='sidebar_container'>
  </div>
</div>

<script>
  $( document ).ready(function() {
    function createSidebarLi(json){
      return ("<li><a>" + json.index + ' (' +json.marker_title + ')' + "</a></li>");
    };

    function bindLiToMarker($li, marker){
      $li.on('click', function(){
        handler.getMap().setZoom(14);
        marker.setMap(handler.getMap()); //because clusterer removes map property from marker
        marker.panTo();
        google.maps.event.trigger(marker.getServiceObject(), 'click');
      })
    };

    function createSidebar(json_array){
      _.each(json_array, function(json){
        var $li = $( createSidebarLi(json) );
        $li.appendTo('#sidebar_container');
        bindLiToMarker($li, json.marker);
      });
    };

    var handler = Gmaps.build('Google');
    handler.buildMap({
        provider: {
          mapTypeId: 'hybrid'
          // disableDefaultUI: true
          // pass in other Google Maps API options here
        },
        internal: {
          id: 'sidebar_builder'
        }
      },
      function(){
        var json_array = <%=raw @hash.to_json %>
        markers = handler.addMarkers(json_array);

        _.each(json_array, function(json, index){
          json.marker = markers[index];
        });

        createSidebar(json_array);
        handler.bounds.extendWith(markers.slice(0, 5));
        handler.fitMapToBounds();
      }
    );

  })
</script>
